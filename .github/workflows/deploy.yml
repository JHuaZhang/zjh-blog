name: Deploy Docs to GitHub Pages & Server

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install
      - name: Build Documentation Site
        run: pnpm run docs:build-site
      - name: Clean Invalid Filenames
        run: |
          echo "ğŸ”§ æ¸…ç†æ–‡ä»¶åä¸­çš„å†’å·..."
          find dist -depth -name '*:*' | while read item; do
            mv "$item" "$(echo "$item" | tr ':' '_')"
          done
          if find dist -name '*:*' | grep -q .; then
            echo "âŒ ä»æœ‰åŒ…å«å†’å·çš„æ–‡ä»¶"
            exit 1
          fi
      - name: Verify Build Output
        run: |
          if [ ! -d 'dist' ]; then
            echo 'âŒ Build output directory dist not found!'
            exit 1
          fi
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4
      - name: Upload Artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist
      - name: Upload Build Artifact for Server
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist/
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-to-server:
    needs: build
    runs-on: ubuntu-latest
    concurrency: deploy-to-server
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: ./dist-to-deploy

      - name: Verify Downloaded Files
        run: |
          echo 'ğŸ“¦ å·²ä¸‹è½½æ„å»ºäº§ç‰©'
          echo "æ–‡ä»¶æ•°é‡ï¼š$(find ./dist-to-deploy -type f | wc -l)"

      - name: Setup SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo '${{ secrets.SSH_PRIVATE_KEY }}' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H '${{ secrets.SERVER_HOST }}' >> ~/.ssh/known_hosts

      - name: Deploy with scp
        run: |
          echo 'ğŸš€ å¼€å§‹ä½¿ç”¨ scp åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨...'
          echo "ç›®æ ‡è·¯å¾„ï¼š${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}"

          # 1. æ¸…ç†æœåŠ¡å™¨ç›®æ ‡ç›®å½•ï¼ˆç¡®ä¿å¹²å‡€ï¼‰
          echo 'ğŸ§¹ æ¸…ç†æœåŠ¡å™¨ç›®æ ‡ç›®å½•...'
          ssh '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' "
            # åˆ é™¤ç›®æ ‡ç›®å½•ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œä½†ä¿ç•™ç›®å½•æœ¬èº«
            if [ -d '${{ secrets.TARGET_PATH }}' ]; then
              rm -rf '${{ secrets.TARGET_PATH }}'/*
              echo 'âœ… ç›®æ ‡ç›®å½•å·²æ¸…ç©º'
            else
              mkdir -p '${{ secrets.TARGET_PATH }}'
              echo 'âœ… ç›®æ ‡ç›®å½•å·²åˆ›å»º'
            fi
          "

          # 2. ä½¿ç”¨ scp é€’å½’å¤åˆ¶æ•´ä¸ªç›®å½•
          echo 'ğŸ“¤ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...'
          scp -r ./dist-to-deploy/* '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}/'

          echo 'âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆï¼'

          # 3. éªŒè¯ä¼ è¾“ç»“æœ
          echo 'ğŸ” éªŒè¯ä¼ è¾“ç»“æœ...'
          ssh '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' "
            echo '========== ä¼ è¾“éªŒè¯ =========='
            echo 'ç›®æ ‡ç›®å½•: ${{ secrets.TARGET_PATH }}'
            echo 'ä¼ è¾“çš„æ–‡ä»¶æ•°é‡: \$(find ${{ secrets.TARGET_PATH }} -type f | wc -l)'
            echo 'ç›®å½•å¤§å°: \$(du -sh ${{ secrets.TARGET_PATH }})'
            echo 'å‰5ä¸ªæ–‡ä»¶:'
            find '${{ secrets.TARGET_PATH }}' -type f | head -5
            echo '=============================='
          "
      # =============================================
      - name: Final Server Verification
        run: |
          echo 'ğŸ” æœ€ç»ˆæœåŠ¡å™¨éªŒè¯...'
          ssh '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' "
            echo '========== æœ€ç»ˆéªŒè¯ =========='
            echo 'æœåŠ¡å™¨æ—¶é—´: \$(date)'
            echo 'éƒ¨ç½²ç›®å½•: ${{ secrets.TARGET_PATH }}'
            echo 'å®Œæ•´æ–‡ä»¶åˆ—è¡¨:'
            ls -la '${{ secrets.TARGET_PATH }}' | head -15
            echo 'æ€»æ–‡ä»¶æ•°: \$(find ${{ secrets.TARGET_PATH }} -type f | wc -l)'
            echo '=============================='
          "

          echo 'ğŸ‰ éƒ¨ç½²å®Œæˆï¼'
