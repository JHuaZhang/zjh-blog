name: Deploy Docs to GitHub Pages & Server

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Build Documentation Site
        run: pnpm run docs:build-site

      - name: Clean invalid filenames (Fix colon issue)
        run: |
          echo "ğŸ”§ æ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦ï¼ˆå†’å·ï¼‰..."

          # æ–¹æ³•1ï¼šä½¿ç”¨findå‘½ä»¤é€’å½’å¤„ç†ï¼ˆé€‚ç”¨äºLinux/macOSï¼‰
          # å¤„ç†åŒ…å«å†’å·çš„ç›®å½•
          find dist -depth -type d -name "*:*" | while read dir; do
            new_dir=$(echo "$dir" | tr ':' '_')
            mv "$dir" "$new_dir"
            echo "ğŸ“ é‡å‘½åç›®å½•: $dir â†’ $new_dir"
          done

          # å¤„ç†åŒ…å«å†’å·çš„æ–‡ä»¶
          find dist -depth -type f -name "*:*" | while read file; do
            new_file=$(echo "$file" | tr ':' '_')
            mv "$file" "$new_file"
            echo "ğŸ“„ é‡å‘½åæ–‡ä»¶: $file â†’ $new_file"
          done

          # æ–¹æ³•2ï¼šå¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨æ›´å®‰å…¨çš„å¤„ç†æ–¹å¼
          # å¦‚æœæœ‰åµŒå¥—çš„å†’å·ï¼Œéœ€è¦å¤šå±‚å¤„ç†
          echo "ğŸ”„ æ‰§è¡ŒäºŒæ¬¡æ¸…ç†æ£€æŸ¥..."
          find dist -depth -name "*:*" | while read item; do
            # è·å–åŸºæœ¬åç§°å’Œç›®å½•
            base_name=$(basename "$item")
            dir_name=$(dirname "$item")
            # æ›¿æ¢æ‰€æœ‰å†’å·
            safe_name=$(echo "$base_name" | tr ':' '_')
            # ç§»åŠ¨
            mv "$item" "$dir_name/$safe_name"
          done

          # éªŒè¯æ¸…ç†ç»“æœ
          echo "âœ… æ¸…ç†å®Œæˆï¼ŒéªŒè¯ç»“æœ..."
          if find dist -name "*:*" -o -name "*:*" | grep -q .; then
            echo "âŒ é”™è¯¯ï¼šä»æœ‰åŒ…å«å†’å·çš„æ–‡ä»¶å"
            find dist -name "*:*"
            exit 1
          else
            echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶åå·²æ¸…ç†å¹²å‡€ï¼"
          fi

      - name: Verify Build Output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build output directory 'dist' not found!"
            exit 1
          else
            echo "âœ… Build output verified in dist/"
            echo "ğŸ“‚ æ–‡ä»¶ç»“æ„ç¤ºä¾‹ï¼š"
            find dist -type f | head -20
          fi

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Upload Build Artifact for Server
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist/
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-to-server:
    needs: build
    runs-on: ubuntu-latest
    concurrency: deploy-to-server
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: ./dist-to-deploy

      - name: Verify Downloaded Files
        run: |
          echo "ğŸ“¦ å·²ä¸‹è½½æ„å»ºäº§ç‰©ï¼š"
          find ./dist-to-deploy -type f | head -10
          echo "ğŸ“Š æ€»æ–‡ä»¶æ•°ï¼š$(find ./dist-to-deploy -type f | wc -l)"

      - name: Setup SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "âœ… ç§é’¥å·²å†™å…¥"

          # æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœºï¼ˆé¿å…äº¤äº’æç¤ºï¼‰
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… æœåŠ¡å™¨ä¸»æœºå¯†é’¥å·²æ·»åŠ "

          # æµ‹è¯•SSHè¿æ¥
          echo "ğŸ” æµ‹è¯•SSHè¿æ¥..."
          ssh -o BatchMode=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSHè¿æ¥æµ‹è¯•æˆåŠŸ'"

      - name: Deploy to Server via rsync
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          echo "ç›®æ ‡è·¯å¾„ï¼š${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}"

          # ä½¿ç”¨rsyncåŒæ­¥ï¼ˆæ˜¾ç¤ºè¿›åº¦ï¼Œæ’é™¤.gitç­‰æ–‡ä»¶ï¼‰
          rsync -avz \
            --progress \
            --delete \
            --exclude='.git*' \
            --exclude='.github' \
            ./dist-to-deploy/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}/

          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"

      - name: Verify Server Deployment
        run: |
          echo "ğŸ” éªŒè¯æœåŠ¡å™¨éƒ¨ç½²..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            echo '========== éƒ¨ç½²éªŒè¯æŠ¥å‘Š =========='
            echo 'æœåŠ¡å™¨æ—¶é—´: $(date)'
            echo 'éƒ¨ç½²è·¯å¾„: ${{ secrets.TARGET_PATH }}'
            echo 'å½“å‰ç”¨æˆ·: $(whoami)'
            echo 'ç›®å½•æƒé™:'
            ls -ld ${{ secrets.TARGET_PATH }}
            echo 'æ–‡ä»¶æ•°é‡ç»Ÿè®¡:'
            find ${{ secrets.TARGET_PATH }} -type f | wc -l
            echo 'ç£ç›˜ä½¿ç”¨æƒ…å†µ:'
            du -sh ${{ secrets.TARGET_PATH }}
            echo 'ç¤ºä¾‹æ–‡ä»¶åˆ—è¡¨:'
            ls -la ${{ secrets.TARGET_PATH }} | head -10
            echo '================================='
          "

          echo "ğŸ‰ æœåŠ¡å™¨éƒ¨ç½²éªŒè¯å®Œæˆï¼"
