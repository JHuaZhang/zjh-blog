name: Deploy Docs to GitHub Pages & Server

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Build Documentation Site
        run: pnpm run docs:build-site

      - name: Clean Invalid Filenames (Fix Colon Issue)
        run: |
          echo "ğŸ”§ æ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦ï¼ˆå†’å·ï¼‰..."
          # é€’å½’å¤„ç†æ‰€æœ‰åŒ…å«å†’å·çš„æ–‡ä»¶å’Œç›®å½•
          find dist -depth -name '*:*' | while read item; do
            new_item=$(echo "$item" | tr ':' '_')
            mv "$item" "$new_item"
            echo "ğŸ“ é‡å‘½å: $item â†’ $new_item"
          done

          # éªŒè¯æ¸…ç†ç»“æœ
          echo "âœ… éªŒè¯æ¸…ç†ç»“æœ..."
          if find dist -name '*:*' | grep -q .; then
            echo "âŒ ä»æœ‰åŒ…å«å†’å·çš„æ–‡ä»¶"
            find dist -name '*:*'
            exit 1
          else
            echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶åå·²æ¸…ç†å¹²å‡€"
          fi

      - name: Verify Build Output
        run: |
          if [ ! -d 'dist' ]; then
            echo 'âŒ Build output directory dist not found!'
            exit 1
          else
            echo 'âœ… Build output verified in dist/'
            echo "ğŸ“‚ æ–‡ä»¶æ•°é‡ï¼š$(find dist -type f | wc -l)"
          fi

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Upload Build Artifact for Server
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist/
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-to-server:
    needs: build
    runs-on: ubuntu-latest
    concurrency: deploy-to-server
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: ./dist-to-deploy

      - name: Verify Downloaded Files
        run: |
          echo 'ğŸ“¦ å·²ä¸‹è½½æ„å»ºäº§ç‰©'
          echo "ğŸ“Š æ€»æ–‡ä»¶æ•°ï¼š$(find ./dist-to-deploy -type f | wc -l)"

      - name: Setup SSH Connection
        run: |
          mkdir -p ~/.ssh

          # å†™å…¥ç§é’¥
          echo '${{ secrets.SSH_PRIVATE_KEY }}' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # éªŒè¯ç§é’¥æ ¼å¼
          echo 'ğŸ” éªŒè¯ç§é’¥æ ¼å¼...'
          if ! head -1 ~/.ssh/id_rsa | grep -q 'BEGIN.*PRIVATE KEY'; then
            echo 'âŒ é”™è¯¯ï¼šç§é’¥ç¼ºå°‘ BEGIN æ ‡è®°è¡Œ'
            echo 'è¯·ç¡®ä¿ GitHub Secret SSH_PRIVATE_KEY åŒ…å«å®Œæ•´çš„ç§é’¥'
            head -2 ~/.ssh/id_rsa
            exit 1
          fi

          if ! tail -1 ~/.ssh/id_rsa | grep -q 'END.*PRIVATE KEY'; then
            echo 'âŒ é”™è¯¯ï¼šç§é’¥ç¼ºå°‘ END æ ‡è®°è¡Œ'
            tail -2 ~/.ssh/id_rsa
            exit 1
          fi

          echo 'âœ… ç§é’¥æ ¼å¼æ­£ç¡®'

          # æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
          ssh-keyscan -H '${{ secrets.SERVER_HOST }}' >> ~/.ssh/known_hosts

          # æµ‹è¯•è¿æ¥
          echo 'ğŸ”— æµ‹è¯• SSH è¿æ¥...'
          if ssh -o BatchMode=yes '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' 'echo SSHè¿æ¥æˆåŠŸ'; then
            echo 'âœ… SSH è¿æ¥æµ‹è¯•é€šè¿‡'
          else
            echo 'âŒ SSH è¿æ¥å¤±è´¥'
            exit 1
          fi

      - name: Install rsync
        run: |
          echo 'ğŸ“¦ å®‰è£… rsync åŒæ­¥å·¥å…·...'
          sudo apt-get update
          sudo apt-get install -y rsync
          echo 'âœ… rsync å®‰è£…å®Œæˆ'

      - name: Deploy to Server via rsync
        run: |
          echo 'ğŸš€ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨...'
          echo "ç›®æ ‡è·¯å¾„ï¼š${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}"

          # ä½¿ç”¨å®Œæ•´è·¯å¾„è°ƒç”¨ rsyncï¼Œé¿å…ç¯å¢ƒé—®é¢˜
          /usr/bin/rsync -avz \
            --progress \
            --delete \
            ./dist-to-deploy/ \
            '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}/'

          echo 'âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ'

      - name: Verify Server Deployment
        run: |
          echo 'ğŸ” éªŒè¯æœåŠ¡å™¨éƒ¨ç½²...'
          ssh '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' "
            echo '========== éƒ¨ç½²éªŒè¯ =========='
            echo 'æœåŠ¡å™¨æ—¶é—´: \$(date)'
            echo 'éƒ¨ç½²ç›®å½•: ${{ secrets.TARGET_PATH }}'
            echo 'ç›®å½•å¤§å°: \$(du -sh ${{ secrets.TARGET_PATH }})'
            echo 'æ–‡ä»¶æ•°é‡: \$(find ${{ secrets.TARGET_PATH }} -type f | wc -l)'
            echo 'ç¤ºä¾‹æ–‡ä»¶:'
            ls -la '${{ secrets.TARGET_PATH }}' | head -5
            echo '=============================='
          "

          echo 'ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼'
