---
group:
  title: Nginx
order: 3
title: nginxè™šæ‹Ÿä¸»æœºåŠåŸŸåè§£æ

nav:
  title: å‘å¸ƒéƒ¨ç½²
  order: 6
---

## 1ã€nginxè™šæ‹Ÿä¸»æœºä»‹ç»
nginx è™šæ‹Ÿä¸»æœºï¼ˆVirtual Hostï¼‰æ˜¯æŒ‡åœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨æˆ–ä¸€ä¸ª nginx å®ä¾‹ä¸Šï¼Œé€šè¿‡é…ç½®å¤šä¸ªç‹¬ç«‹çš„ç½‘ç«™ï¼ˆæˆ–æœåŠ¡ï¼‰ï¼Œä½¿å®ƒä»¬çœ‹èµ·æ¥åƒæ˜¯è¿è¡Œåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚è¿™ç§æœºåˆ¶å…è®¸ä½ ä½¿ç”¨åŒä¸€ä¸ª IP åœ°å€å’Œç«¯å£ï¼ˆé€šå¸¸æ˜¯ 80 æˆ– 443ï¼‰æ‰˜ç®¡å¤šä¸ªåŸŸåæˆ–å­åŸŸåï¼Œæ¯ä¸ªåŸŸåå¯ä»¥æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ç½‘ç«™å†…å®¹ã€é…ç½®å’Œæ—¥å¿—ã€‚

nginx ä¸­çš„è™šæ‹Ÿä¸»æœºé€šå¸¸é€šè¿‡ server å—ï¼ˆserver blockï¼‰ æ¥å®ç°ï¼Œè¿™ç±»ä¼¼äº Apache ä¸­çš„ VirtualHostã€‚

**è™šæ‹Ÿä¸»æœºçš„ä¸¤ç§ä¸»è¦ç±»å‹ï¼š**

1. **åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºï¼ˆName-based Virtual Hostingï¼‰:**
    1. å¤šä¸ªç½‘ç«™å…±äº«åŒä¸€ä¸ª IP åœ°å€å’Œç«¯å£ã€‚
    2. nginx æ ¹æ® HTTP è¯·æ±‚å¤´ä¸­çš„ Host å­—æ®µæ¥åˆ¤æ–­ç”¨æˆ·è®¿é—®çš„æ˜¯å“ªä¸ªç«™ç‚¹ã€‚
    3. è¿™æ˜¯æœ€å¸¸è§çš„è™šæ‹Ÿä¸»æœºæ–¹å¼ï¼Œé€‚ç”¨äºå¤§å¤šæ•° Web æ‰˜ç®¡åœºæ™¯ã€‚
2. **åŸºäº IP çš„è™šæ‹Ÿä¸»æœºï¼ˆIP-based Virtual Hostingï¼‰:**
    1. æ¯ä¸ªç½‘ç«™ç»‘å®šåˆ°æœåŠ¡å™¨ä¸Šçš„ä¸åŒ IP åœ°å€ï¼ˆå³ä½¿ç«¯å£ç›¸åŒï¼‰ã€‚
    2. nginx æ ¹æ®è¯·æ±‚åˆ°è¾¾çš„ IP åœ°å€æ¥åŒºåˆ†ç«™ç‚¹ã€‚
    3. éœ€è¦æœåŠ¡å™¨é…ç½®å¤šä¸ª IP åœ°å€ï¼Œä½¿ç”¨è¾ƒå°‘ã€‚

### 1.1ã€åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœº
**åŸºæœ¬åŸç†ï¼š**

+ å¤šä¸ªç½‘ç«™å…±äº«åŒä¸€ä¸ª IP åœ°å€å’Œç«¯å£ï¼ˆå¦‚ 80 æˆ– 443ï¼‰ã€‚
+ nginx æ ¹æ®å®¢æˆ·ç«¯ HTTP è¯·æ±‚å¤´ä¸­çš„ Host å­—æ®µ æ¥åˆ¤æ–­ç”¨æˆ·è®¿é—®çš„æ˜¯å“ªä¸ªåŸŸåï¼Œä»è€Œé€‰æ‹©å¯¹åº”çš„ server å—è¿›è¡Œå¤„ç†ã€‚
+ è¿™æ˜¯ç›®å‰æœ€ä¸»æµã€æœ€å¸¸ç”¨çš„è™šæ‹Ÿä¸»æœºæ–¹å¼ã€‚

æ³¨æ„ï¼šHTTP/1.1 åè®®è¦æ±‚å®¢æˆ·ç«¯å¿…é¡»åœ¨è¯·æ±‚ä¸­åŒ…å« Host å¤´ï¼Œå› æ­¤ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒè¿™ç§æ–¹å¼ã€‚

**é…ç½®ç¤ºä¾‹ï¼š**

```nginx
# ç½‘ç«™ Aï¼šexample.com
server {
  listen 80;
  server_name example.com www.example.com;
  root /var/www/example.com;
  index index.html;
}

# ç½‘ç«™ Bï¼štest.com
server {
  listen 80;
  server_name test.com www.test.com;
  root /var/www/test.com;
  index index.html;
}
```

ä¸¤ä¸ª server å—éƒ½ç›‘å¬ 80 ç«¯å£ï¼Œä½†é€šè¿‡ server_name åŒºåˆ†ã€‚

**ä¼˜ç‚¹ï¼š**

+ èŠ‚çœ IP åœ°å€èµ„æºï¼šå°¤å…¶åœ¨ IPv4 åœ°å€ç¨€ç¼ºçš„ç¯å¢ƒä¸‹éå¸¸å…³é”®ã€‚
+ é…ç½®ç®€å•ï¼šåªéœ€æ·»åŠ æ–°çš„ server å—å¹¶æŒ‡å®šåŸŸåã€‚
+ æ˜“äºæ‰©å±•ï¼šå¯è½»æ¾æ‰˜ç®¡æˆç™¾ä¸Šåƒä¸ªç½‘ç«™äºåŒä¸€å°æœåŠ¡å™¨ã€‚
+ æ”¯æŒ HTTPSï¼ˆé…åˆ SNIï¼‰ï¼šç°ä»£æµè§ˆå™¨å’Œ nginx æ”¯æŒ Server Name Indicationï¼ˆSNIï¼‰ï¼Œå¯åœ¨åŒä¸€ IP ä¸Šä¸ºä¸åŒåŸŸåæä¾›ä¸åŒçš„ SSL è¯ä¹¦ã€‚

**ç¼ºç‚¹ï¼š**

+ ä¾èµ– Host å¤´ï¼šå¦‚æœå®¢æˆ·ç«¯ä¸å‘é€ Hostï¼ˆå¦‚ä½¿ç”¨ HTTP/1.0 ä¸”æœªæ‰‹åŠ¨æŒ‡å®šï¼‰ï¼Œnginx ä¼šä½¿ç”¨é»˜è®¤çš„ server å—ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªæˆ–æ ‡è®°ä¸º default_server çš„ï¼‰ã€‚
+ æ—§è®¾å¤‡æˆ–ç‰¹æ®Šå®¢æˆ·ç«¯å¯èƒ½ä¸å…¼å®¹ï¼šæå°‘æ•°è€æ—§ç³»ç»Ÿæˆ–è‡ªå®šä¹‰ HTTP å®¢æˆ·ç«¯å¯èƒ½ä¸æ”¯æŒ Host å¤´ã€‚
+ SSL æ—©æœŸé™åˆ¶ï¼šåœ¨æ²¡æœ‰ SNI çš„æ—¶ä»£ï¼ˆ2000 å¹´ä»£åˆï¼‰ï¼Œæ— æ³•åœ¨åŒä¸€ IP ä¸Šä¸ºå¤šä¸ªåŸŸåæä¾› HTTPSã€‚ä½†ç°åœ¨ SNI å·²å¹¿æ³›æ”¯æŒï¼ˆé™¤ Windows XP ç­‰æè€ç³»ç»Ÿå¤–ï¼‰ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**

+ ç»å¤§å¤šæ•° Web æ‰˜ç®¡åœºæ™¯ï¼ˆåšå®¢ã€ä¼ä¸šå®˜ç½‘ã€ç”µå•†å¹³å°ç­‰ï¼‰ã€‚
+ å…±äº«ä¸»æœºã€äº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²å¤šä¸ªå®¢æˆ·ç«™ç‚¹ã€‚
+ ä½¿ç”¨ Let's Encrypt ç­‰å…è´¹è¯ä¹¦ä¸ºå¤šä¸ªåŸŸåå¯ç”¨ HTTPSã€‚

### 1.2ã€åŸºäºIPçš„è™šæ‹Ÿä¸»æœº
**åŸºæœ¬åŸç†ï¼š**

+ æ¯ä¸ªç½‘ç«™ç»‘å®šåˆ°æœåŠ¡å™¨ä¸Šçš„ä¸åŒ IP åœ°å€ï¼ˆå³ä½¿ç«¯å£ç›¸åŒï¼‰ã€‚
+ nginx æ ¹æ®è¯·æ±‚åˆ°è¾¾çš„ IP åœ°å€æ¥å†³å®šä½¿ç”¨å“ªä¸ª server å—ã€‚
+ ä¸ä¾èµ– Host å¤´ï¼Œå› æ­¤å³ä½¿å®¢æˆ·ç«¯ä¸å‘é€ Hostï¼Œä¹Ÿèƒ½æ­£ç¡®è·¯ç”±ã€‚

å‡è®¾æœåŠ¡å™¨æœ‰ä¸¤ä¸ª IP åœ°å€ï¼š192.168.1.10 å’Œ 192.168.1.11ï¼š

```nginx
# ç½‘ç«™ Aï¼šç»‘å®šåˆ° 192.168.1.10
server {
  listen 192.168.1.10:80;
  server_name example.com;
  root /var/www/example.com;
}

# ç½‘ç«™ Bï¼šç»‘å®šåˆ° 192.168.1.11
server {
  listen 192.168.1.11:80;
  server_name test.com;
  root /var/www/test.com;
}
```

ä¹Ÿå¯ä»¥åªå†™ IPï¼Œä¸å†™åŸŸåï¼ˆserver_name _;ï¼‰ï¼Œå› ä¸º IP æœ¬èº«å·²è¶³å¤ŸåŒºåˆ†ã€‚ä¸è¿‡æ³¨æ„ä¸¤ä¸ªIPéƒ½æ˜¯è¿™å°ç‰©ç†æœåŠ¡å™¨çš„IPåœ°å€ï¼Œè€Œä¸æ˜¯å…¶å®ƒçš„æœåŠ¡å™¨IPåœ°å€ã€‚

**ä¼˜ç‚¹ï¼š**

+ ä¸ä¾èµ– Host å¤´ï¼šå…¼å®¹æ‰€æœ‰ HTTP å®¢æˆ·ç«¯ï¼ŒåŒ…æ‹¬ HTTP/1.0ã€‚
+ æ›´â€œå¹²å‡€â€çš„éš”ç¦»ï¼šæ¯ä¸ªç«™ç‚¹æœ‰ç‹¬ç«‹ IPï¼Œä¾¿äºç½‘ç»œå±‚ç›‘æ§ã€é˜²ç«å¢™è§„åˆ™ã€æ—¥å¿—åˆ†æç­‰ã€‚
+ ä¼ ç»Ÿ SSL å…¼å®¹æ€§å¥½ï¼šåœ¨ SNI å‡ºç°ä¹‹å‰ï¼Œè¿™æ˜¯å®ç°å¤š HTTPS ç«™ç‚¹çš„å”¯ä¸€æ–¹å¼ã€‚

**ç¼ºç‚¹ï¼š**

+ æ¶ˆè€—å¤§é‡å…¬ç½‘ IP åœ°å€ï¼šIPv4 åœ°å€æ˜‚è´µä¸”ç¨€ç¼ºï¼Œä¸é€‚ç”¨äºå¤§è§„æ¨¡éƒ¨ç½²ã€‚
+ é…ç½®å¤æ‚ï¼šéœ€è¦ä¸ºæœåŠ¡å™¨åˆ†é…å¤šä¸ª IPï¼Œå¹¶ç¡®ä¿ DNS æ­£ç¡®æŒ‡å‘ã€‚
+ è¿ç»´æˆæœ¬é«˜ï¼šIP ç®¡ç†ã€é˜²ç«å¢™è§„åˆ™ã€SSL è¯ä¹¦ç»‘å®šç­‰æ›´ç¹çã€‚
+ äº‘ç¯å¢ƒé™åˆ¶ï¼šæŸäº›äº‘æœåŠ¡å•†ï¼ˆå¦‚ AWS EC2ï¼‰å¯¹å¼¹æ€§ IP æ•°é‡æœ‰é™åˆ¶æˆ–é¢å¤–æ”¶è´¹ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**

+ éœ€è¦å…¼å®¹ä¸æ”¯æŒ Host å¤´çš„è€æ—§ç³»ç»Ÿã€‚
+ æŸäº›å®‰å…¨æˆ–åˆè§„è¦æ±‚ï¼ˆå¦‚ PCI DSSï¼‰æ›¾å»ºè®®ç‹¬ç«‹ IPï¼ˆä½†ç°ä»£æ ‡å‡†å·²ä¸å†å¼ºåˆ¶ï¼‰ã€‚
+ å†…éƒ¨æµ‹è¯•ç¯å¢ƒï¼Œæ–¹ä¾¿é€šè¿‡ä¸åŒ IP å¿«é€ŸåŒºåˆ†æœåŠ¡ã€‚
+ ä¸ºä¸æ”¯æŒ SNI çš„æè€å®¢æˆ·ç«¯ï¼ˆå¦‚ Windows XP + IE6ï¼‰æä¾› HTTPSï¼ˆç°å·²æå°‘ä½¿ç”¨ï¼‰ã€‚

**ä¸€å°æœåŠ¡å™¨å¯ä»¥æœ‰å¤šä¸ª IP åœ°å€ï¼š**

è™½ç„¶æˆ‘ä»¬é€šå¸¸è®¤ä¸ºâ€œä¸€å°æœåŠ¡å™¨ = ä¸€ä¸ª IPâ€ï¼Œä½†å®é™…ä¸Šï¼š

+ ä¸€å°æœåŠ¡å™¨å¯ä»¥é…ç½® å¤šä¸ª IP åœ°å€ï¼ˆç§°ä¸ºâ€œIP åˆ«åâ€æˆ–â€œè¾…åŠ© IPâ€ï¼‰ã€‚
+ è¿™äº› IP å¯ä»¥åœ¨åŒä¸€ä¸ªç½‘å¡ä¸Šï¼ˆå¦‚ eth0ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒç½‘å¡ä¸Šã€‚
+ åœ¨ Linux ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ IPï¼š

```bash
ip addr show
# æˆ–
ifconfig -a
```

å¦‚ä¸‹æ˜¯æˆ‘ä»¬çš„é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸­çš„é…ç½®ï¼š

```bash
[root@iZ2zeb9fdjcne1mfh06bmoZ ~]# ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:16:3e:2c:7e:b3 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    altname ens5
    inet 172.27.23.94/20 brd 172.27.31.255 scope global dynamic noprefixroute eth0
       valid_lft 1891993731sec preferred_lft 1891993731sec
    inet6 fe80::216:3eff:fe2c:7eb3/64 scope link 
       valid_lft forever preferred_lft forever
3: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:70:23:13:01 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:70ff:fe23:1301/64 scope link 
       valid_lft forever preferred_lft forever
7: veth48155da@if6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP group default 
    link/ether 5a:f9:8c:86:ac:3f brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::58f9:8cff:fe86:ac3f/64 scope link 
       valid_lft forever preferred_lft forever
```

	ip addr showï¼ˆä¹Ÿå¯ç®€å†™ä¸º ip aï¼‰ä¼šåˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰ç½‘ç»œæ¥å£ï¼ˆnetwork interfacesï¼‰åŠå…¶é…ç½®çš„ IP åœ°å€ï¼ˆåŒ…æ‹¬ IPv4 å’Œ IPv6ï¼‰ã€‚

ä¸Šé¢çš„è¾“å‡ºåŒ…å« 3 ä¸ªä¸»è¦ç½‘ç»œæ¥å£ï¼šloã€eth0ã€docker0ï¼Œä»¥åŠä¸€ä¸ªè™šæ‹Ÿä»¥å¤ªç½‘è®¾å¤‡ veth48155daï¼ˆç”¨äº Docker å®¹å™¨é€šä¿¡ï¼‰ã€‚

**â‘ ã€lo â€”â€” å›ç¯æ¥å£**

```bash
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
```

+ ä½œç”¨ï¼šç”¨äºæœ¬æœºå†…éƒ¨é€šä¿¡ï¼ˆä¾‹å¦‚è®¿é—® localhost æˆ– 127.0.0.1ï¼‰ã€‚
+ IPv4 åœ°å€ï¼š127.0.0.1/8 â†’ æ‰€æœ‰ 127.x.x.x éƒ½å±äºå›ç¯åœ°å€ã€‚
+ IPv6 åœ°å€ï¼š::1 â†’ IPv6 çš„ localhostã€‚

**â‘¡ã€eth0 â€”â€” ä¸»ç½‘ç»œæ¥å£(å…¬ç½‘/å†…ç½‘å‡ºå£)**

```bash
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:16:3e:2c:7e:b3 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    altname ens5
    inet 172.27.23.94/20 brd 172.27.31.255 scope global dynamic noprefixroute eth0
       valid_lft 1891993731sec preferred_lft 1891993731sec
    inet6 fe80::216:3eff:fe2c:7eb3/64 scope link 
       valid_lft forever preferred_lft forever
```

| é¡¹ç›® | è¯´æ˜ |
| --- | --- |
| æ¥å£å | eth0ï¼ˆä¼ ç»Ÿå‘½åï¼‰ï¼Œä¹Ÿæ”¯æŒåˆ«åenp0s5ã€ens5ï¼ˆæ–°å¼å‘½åè§„åˆ™ï¼‰ |
| MAC åœ°å€ | 00:16:3e:2c:7e:b3â†’ ç‰©ç†ç½‘å¡å”¯ä¸€æ ‡è¯† |
| IPv4 åœ°å€ | 172.27.23.94/20 |
| å­ç½‘æ©ç  | /20è¡¨ç¤ºå‰ 20 ä½æ˜¯ç½‘ç»œä½ â†’ å­ç½‘æ©ç ä¸º255.255.240.0 |
| ç½‘ç»œèŒƒå›´ | 172.27.16.0åˆ°172.27.31.255ï¼ˆå› ä¸º/20= 16 ä¸ª C ç±»ç½‘æ®µï¼‰ |
| å¹¿æ’­åœ°å€ | 172.27.31.255 |
| IP è·å–æ–¹å¼ | dynamicâ†’ é€šè¿‡ DHCP è·å–ï¼ˆå¸¸è§äºäº‘æœåŠ¡å™¨ï¼‰ |
| çŠ¶æ€ | state UPâ†’ æ¥å£å·²å¯ç”¨ï¼Œæ­£å¸¸å·¥ä½œ |
| IPv6 åœ°å€ | fe80::...â†’ é“¾è·¯æœ¬åœ°åœ°å€ï¼ˆä»…ç”¨äºæœ¬å±€åŸŸç½‘é€šä¿¡ï¼‰ |


å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å…¬ç½‘ IP:

```bash
curl ifconfig.me
# æˆ–
curl ipinfo.io/ip
```

**â‘¢ã€docker0 â€”â€” Dockerè™šæ‹Ÿç½‘æ¡¥**

```bash
3: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:70:23:13:01 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:70ff:fe23:1301/64 scope link 
       valid_lft forever preferred_lft forever
```

+ ä½œç”¨ï¼šDocker åˆ›å»ºçš„è™šæ‹Ÿç½‘æ¡¥ï¼Œç”¨äºå®¹å™¨ä¸å®¿ä¸»æœºé€šä¿¡ã€‚
+ IP åœ°å€ï¼š172.17.0.1/16 â†’ Docker é»˜è®¤çš„ç§æœ‰ç½‘ç»œï¼ˆå®¹å™¨é€šå¸¸è·å¾— 172.17.0.2ã€172.17.0.3 ç­‰ IPï¼‰ã€‚
+ âœ… å¦‚æœè¿è¡Œäº† Docker å®¹å™¨ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚

**â‘£ã€veth48155da@if6 â€”â€” Dockerè™šæ‹Ÿä»¥å¤ªç½‘å¯¹**

```bash
veth48155da@if6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP group default 
    link/ether 5a:f9:8c:86:ac:3f brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::58f9:8cff:fe86:ac3f/64 scope link 
       valid_lft forever preferred_lft forever
```

+ ä½œç”¨ï¼šè¿™æ˜¯ Docker ä¸ºæŸä¸ªå®¹å™¨åˆ›å»ºçš„è™šæ‹Ÿç½‘å¡ï¼Œä¸€ç«¯åœ¨å®¿ä¸»æœºï¼ˆveth48155daï¼‰ï¼Œå¦ä¸€ç«¯åœ¨å®¹å™¨å†…éƒ¨ï¼ˆif6 è¡¨ç¤ºå®¹å™¨å†…çš„æ¥å£ç¼–å·ï¼‰ã€‚
+ å®ƒè¢«ç»‘å®šåˆ° docker0 ç½‘æ¡¥ï¼ˆmaster docker0ï¼‰ã€‚
+ æ²¡æœ‰ IPv4 åœ°å€æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºå®¹å™¨å†…éƒ¨æ‰æœ‰å®Œæ•´ IP æ ˆã€‚

å¦‚æœæˆ‘ä»¬æƒ³é…ç½®ä¸åŒçš„è¾…åŠ©IPï¼Œå¯ä»¥ï¼š

+ ç™»å½• é˜¿é‡Œäº‘æ§åˆ¶å° â†’ äº‘æœåŠ¡å™¨ ECS â†’ ç½‘ç»œä¸å®‰å…¨ â†’ å¼¹æ€§ç½‘å¡
+ æ‰¾åˆ°ä¸»ç½‘å¡ â†’ æ·»åŠ è¾…åŠ©ç§ç½‘ IPï¼ˆä¾‹å¦‚ 172.27.23.95ï¼‰
+ åœ¨æœåŠ¡å™¨ä¸­å¯ç”¨è¯¥ IPï¼š

```bash
sudo ip addr add 172.27.23.95/20 dev eth0
```

+ ç„¶å nginx å°±å¯ä»¥ç›‘å¬ 172.27.23.94:80 å’Œ 172.27.23.95:80 äº†ã€‚

æ³¨æ„ï¼šè¿™äº›æ˜¯å†…ç½‘ IPï¼Œå¤–éƒ¨ç”¨æˆ·æ— æ³•ç›´æ¥è®¿é—®ã€‚éœ€è¦é…åˆå…¬ç½‘ IP + ç«¯å£è½¬å‘ æˆ– SLBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ æ‰èƒ½è®©å¤–ç½‘è®¿é—®ä¸åŒ IP ä¸Šçš„æœåŠ¡ã€‚

å†è¾“å‡ºipé…ç½®å°±å¯ä»¥çœ‹åˆ°ï¼š

```bash
inet 172.27.23.94/20 ... eth0   # ä¸» IP
inet 172.27.23.95/20 ... secondary eth0  # æ–°å¢çš„è¾…åŠ© IP
```

æœåŠ¡å™¨ç°åœ¨åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªå†…ç½‘ IPï¼š

```bash
172.27.23.94
172.27.23.95
```

å®ƒä»¬éƒ½åœ¨åŒä¸€ä¸ªå­ç½‘ï¼ˆ/20ï¼Œå³ 172.27.16.0 â€“ 172.27.31.255ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥äº’ç›¸é€šä¿¡ã€‚æ³¨æ„ï¼šè¿™ä¸¤ä¸ªéƒ½æ˜¯å†…ç½‘ç§æœ‰ IPï¼Œå¤–éƒ¨ç”¨æˆ·æ— æ³•ç›´æ¥é€šè¿‡å®ƒä»¬è®¿é—®ä¸Šé¢çš„æœåŠ¡ã€‚ä½†åœ¨å†…ç½‘æµ‹è¯•æˆ–é…åˆäº‘å¹³å°çš„å…¬ç½‘æ˜ å°„/è´Ÿè½½å‡è¡¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åŸºäºIPçš„è™šæ‹Ÿä¸»æœºã€‚

å› æ­¤åœ¨å†…ç½‘ç¯å¢ƒä¸‹ï¼š

```nginx
# ç½‘ç«™ Aï¼šç»‘å®šåˆ° 172.27.23.94
server {
  listen 172.27.23.94:80;
  server_name _;  # ä¸ä¾èµ–åŸŸå
  root /var/www/siteA;
  index index.html;
  location / {
    try_files $uri $uri/ =404;
  }
}

# ç½‘ç«™ Bï¼šç»‘å®šåˆ° 172.27.23.95
server {
  listen 172.27.23.95:80;
  server_name _;
  root /var/www/siteB;
  index index.html;
  location / {
    try_files $uri $uri/ =404;
  }
}
```

```bash
sudo mkdir -p /var/www/siteA /var/www/siteB

echo "<h1>Site A - IP 172.27.23.94</h1>" | sudo tee /var/www/siteA/index.html
echo "<h1>Site B - IP 172.27.23.95</h1>" | sudo tee /var/www/siteB/index.html
```

```bash
# è®¿é—®ç¬¬ä¸€ä¸ª IP
curl http://172.27.23.94
# è¾“å‡º: <h1>Site A - IP 172.27.23.94</h1>

# è®¿é—®ç¬¬äºŒä¸ª IP
curl http://172.27.23.95
# è¾“å‡º: <h1>Site B - IP 172.27.23.95</h1>
```

	ä½†æ˜¯è¿™é‡Œæ³¨æ„æˆ‘ä»¬æ— æ³•é€šè¿‡å…¬ç½‘æ¥è®¿é—®172.27.23.95ï¼Œå› ä¸ºåœ¨äº‘æœåŠ¡å™¨ï¼ˆå¦‚é˜¿é‡Œäº‘ï¼‰ä¸­ï¼š

+ å…¬ç½‘ IP æ˜¯é€šè¿‡ NAT æ˜ å°„ åˆ°å†…ç½‘ IPï¼ˆ172.27.23.94ï¼‰çš„ã€‚
+ æ‰€æœ‰å…¬ç½‘æµé‡éƒ½å…ˆåˆ°è¾¾ 172.27.23.94ï¼Œä¸ä¼šè‡ªåŠ¨è½¬å‘åˆ° 172.27.23.95ã€‚
+ æ‰€ä»¥ï¼Œå¤–ç½‘ç”¨æˆ·æ— æ³•ç›´æ¥é€šè¿‡å…¬ç½‘ IP è®¿é—® 172.27.23.95 ä¸Šçš„æœåŠ¡ã€‚

å¦‚æœæƒ³è®©å¤–ç½‘è®¿é—®ä¸¤ä¸ªä¸åŒç«™ç‚¹ï¼Œæœ‰ä»¥ä¸‹æ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ | è¯´æ˜ |
| --- | --- |
| âœ… ç»§ç»­ç”¨åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœº | æœ€ç®€å•ï¼ä¸¤ä¸ªåŸŸåéƒ½è§£æåˆ°å…¬ç½‘IPï¼Œnginx ç”¨server_nameåŒºåˆ† |
| ğŸ” ä½¿ç”¨ SLBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ | é˜¿é‡Œäº‘ SLB å¯ä»¥å°†ä¸åŒåŸŸå/è·¯å¾„è½¬å‘åˆ°ä¸åŒåç«¯ IPï¼ˆåŒ…æ‹¬172.27.23.95ï¼‰ |
| ğŸš« ç›´æ¥ç”¨ä¸¤ä¸ªå…¬ç½‘ IP | éœ€è¦ç”³è¯·ç¬¬äºŒä¸ªå¼¹æ€§å…¬ç½‘ IPï¼ˆEIPï¼‰å¹¶ç»‘å®šåˆ°è¾…åŠ©ç§ç½‘ IPï¼Œä¼šäº§ç”Ÿé¢å¤–è´¹ç”¨ |


é™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆå¦‚æµ‹è¯•ã€åˆè§„è¦æ±‚ã€è€æ—§ç³»ç»Ÿå…¼å®¹ï¼‰ï¼Œå¦åˆ™ä¼˜å…ˆä½¿ç”¨åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºã€‚

## 2ã€nginxåŸŸåè§£æ
nginx æœ¬èº«å¹¶ä¸ç›´æ¥è¿›è¡ŒåŸŸåè§£æï¼ˆDNS è§£æï¼‰ï¼Œä½†å®ƒåœ¨é…ç½®ä¸­ä¼šç”¨åˆ°åŸŸåï¼Œå¹¶ä¾èµ–æ“ä½œç³»ç»Ÿçš„ DNS è§£ææœºåˆ¶æˆ–é€šè¿‡ resolver æŒ‡ä»¤å®ç°åŠ¨æ€è§£æã€‚

### 2.1ã€nginxä¸­ä½¿ç”¨åŸŸåçš„å¸¸è§åœºæ™¯
**â‘ ã€upstreamæœåŠ¡å™¨åœ°å€**

åœ¨å®šä¹‰åç«¯æœåŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åŸŸåï¼š

```nginx
upstream backend {
  server api.example.com:80;
}
```

**â‘¡ã€proxy_pass / fastcgi_passç­‰æŒ‡ä»¤ä¸­çš„ç›®æ ‡åœ°å€**

```nginx
location / {
  proxy_pass http://backend.example.com;
}
```

**â‘¢ã€server_nameæŒ‡ä»¤ï¼ˆç”¨äºè™šæ‹Ÿä¸»æœºåŒ¹é…ï¼‰**

æ³¨æ„ï¼šserver_name ä¸­çš„åŸŸåæ˜¯ç”¨äºåŒ¹é…å®¢æˆ·ç«¯è¯·æ±‚çš„ Host å¤´ï¼Œä¸æ¶‰åŠ DNS è§£æã€‚

### 2.2ã€nginxçš„åŸŸåè§£ææœºåˆ¶
#### 2.2.1ã€é™æ€è§£æï¼ˆå¯åŠ¨æ—¶è§£æï¼‰
+ å¦‚æœåœ¨ upstream æˆ– proxy_pass ä¸­ç›´æ¥ä½¿ç”¨åŸŸåï¼ˆä¸”æœªé…ç½® resolverï¼‰ï¼Œnginx ä¼šåœ¨å¯åŠ¨æˆ–é‡è½½é…ç½®æ—¶è§£æä¸€æ¬¡è¯¥åŸŸåã€‚
+ è§£æç»“æœä¼šè¢«ç¼“å­˜æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå³ä½¿ DNS è®°å½•åç»­å‘ç”Ÿå˜åŒ–ï¼Œnginx ä¹Ÿä¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚
+ è¿™å¯èƒ½å¯¼è‡´é—®é¢˜ï¼šä¾‹å¦‚åç«¯æœåŠ¡ IP å˜æ›´åï¼Œnginx ä»ä½¿ç”¨æ—§ IPã€‚

```nginx
location / {
  proxy_pass http://myapp.com;  # å¯åŠ¨æ—¶è§£æä¸€æ¬¡ï¼Œä¹‹åä¸å†æ›´æ–°
}
```

#### 2.2.2ã€åŠ¨æ€è§£æï¼ˆè¿è¡Œæ—¶è§£æï¼‰
+ ä½¿ç”¨ resolver æŒ‡ä»¤å¯è®© nginx åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æåŸŸåã€‚
+ éœ€é…åˆå˜é‡ï¼ˆå¦‚ $hostï¼‰ä½¿ç”¨ï¼Œå› ä¸ºåªæœ‰åœ¨å˜é‡ä¸Šä¸‹æ–‡ä¸­ï¼Œnginx æ‰ä¼šè§¦å‘ DNS æŸ¥è¯¢ã€‚
+ å¯è®¾ç½® valid å‚æ•°æ§åˆ¶ç¼“å­˜æ—¶é—´ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª nginx åŠ¨æ€ DNS è§£æ çš„å®Œæ•´ã€å¯è¿è¡Œçš„é…ç½®ç¤ºä¾‹ï¼Œé€‚ç”¨äºåç«¯æœåŠ¡ IP å¯èƒ½å˜åŒ–ï¼ˆå¦‚ Kubernetes æœåŠ¡ã€äº‘ä¸ŠåŠ¨æ€å®ä¾‹ã€æˆ–ä½¿ç”¨åŠ¨æ€ DNS çš„åœºæ™¯ï¼‰ã€‚

+ å‰ç«¯ç”¨æˆ·è®¿é—® [http://your-nginx-server/](http://your-nginx-server/)ã€‚
+ nginx å°†è¯·æ±‚åå‘ä»£ç†åˆ° [http://backend.example.com](http://backend.example.com)ã€‚
+ backend.example.com çš„ IP åœ°å€å¯èƒ½ä¼šå˜åŒ–ï¼ˆä¾‹å¦‚æ˜¯äº‘æœåŠ¡æˆ–å®¹å™¨æœåŠ¡ï¼‰ã€‚
+ æˆ‘ä»¬å¸Œæœ› nginx å®šæœŸé‡æ–°è§£æè¯¥åŸŸåï¼Œè€Œä¸æ˜¯åªåœ¨å¯åŠ¨æ—¶è§£æä¸€æ¬¡ã€‚

```nginx
# /etc/nginx/conf.d/dynamic-resolver.conf

# å®šä¹‰ DNS è§£æå™¨ï¼ˆå¯é€‰å¤šä¸ªï¼Œæ”¯æŒ IPv4/IPv6ï¼‰
resolver 8.8.8.8 114.114.114.114 valid=30s;

server {
  listen 80;
  server_name your-nginx-server;  # å¯æ›¿æ¢ä¸ºå®é™…åŸŸåæˆ–ç•™ç©º

  location / {
    # å…³é”®ï¼šå¿…é¡»ä½¿ç”¨å˜é‡ï¼ä¸èƒ½ç›´æ¥å†™åŸŸå
    set $backend "backend.example.com";
    proxy_pass http://$backend;

    # å¯é€‰ï¼šä¼ é€’ Host å¤´ï¼ˆå¦‚æœåç«¯éœ€è¦ï¼‰
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }
}
```

| è¦ç´  | è¯´æ˜ |
| --- | --- |
| resolver | æŒ‡å®š DNS æœåŠ¡å™¨ã€‚valid=30sï¼Œè¡¨ç¤º DNS ç»“æœç¼“å­˜ 30 ç§’ï¼Œä¹‹åé‡æ–°æŸ¥è¯¢ |
| set $backend "backend.example.com"; | å°†åŸŸåèµ‹å€¼ç»™å˜é‡$backend |
| proxy_pass http://$backend; | å¿…é¡»ä½¿ç”¨å˜é‡ï¼Œnginx æ‰ä¼šåœ¨è¿è¡Œæ—¶è§¦å‘ DNS æŸ¥è¯¢ |
| âŒ é”™è¯¯å†™æ³• | proxy_pass http://backend.example.com;â†’ è¿™æ ·åªä¼šå¯åŠ¨æ—¶è§£æä¸€æ¬¡ï¼Œä¸ä¼šåŠ¨æ€æ›´æ–°ï¼ |


### 2.3ã€resolveræŒ‡ä»¤è¯¦è§£
```nginx
resolver address ... [valid=time] [ipv6=on|off];
```

+ addressï¼šDNS æœåŠ¡å™¨åœ°å€ï¼Œå¦‚ 8.8.8.8ã€114.114.114.114ã€‚resolver æŒ‡ä»¤ä¸­çš„ addressï¼Œä¸æ˜¯æŒ‡å½“å‰æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œæ˜¯æŒ‡ nginx åº”è¯¥å‘å“ªäº› DNS æœåŠ¡å™¨å‘èµ·åŸŸåè§£æè¯·æ±‚ã€‚

| åœºæ™¯ | æ¨èçš„resolver åœ°å€ |
| --- | --- |
| æ™®é€šäº‘æœåŠ¡å™¨ï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼‰ | 223.5.5.5ï¼ˆé˜¿é‡Œ DNSï¼‰æˆ–114.114.114.114 |
| æƒ³ç”¨å…¨çƒå¿«é€Ÿ DNS | 8.8.8.8ï¼ˆGoogleï¼‰æˆ– 1.1.1.1ï¼ˆCloudflareï¼‰ |
| Docker å®¹å™¨å†… | 127.0.0.11ï¼ˆDocker å†…ç½® DNSï¼‰ |
| Kubernetes Pod å†… | é€šå¸¸æ˜¯é›†ç¾¤ DNSï¼Œå¦‚ 10.96.0.10ï¼ˆå¯é€šè¿‡cat /etc/resolv.confæŸ¥çœ‹ï¼‰ |
| å…¬å¸å†…ç½‘æœ‰ç§æœ‰ DNS | å¡«ITæä¾›çš„DNSæœåŠ¡å™¨IPï¼ˆå¦‚192.168.10.10ï¼‰ |


å¯ä»¥é€šè¿‡æŸ¥çœ‹æœåŠ¡å™¨çš„ /etc/resolv.conf æ–‡ä»¶ï¼Œçœ‹çœ‹ç³»ç»Ÿé»˜è®¤ç”¨çš„æ˜¯å“ªä¸ª DNSï¼š

```bash
cat /etc/resolv.conf
```

+ valid=timeï¼šç¼“å­˜ DNS ç»“æœçš„æ—¶é—´ï¼Œé»˜è®¤ä¸º 5 ç§’ï¼ˆä½†æŸäº›ç‰ˆæœ¬å¯èƒ½ä¸åŒï¼‰ã€‚
+ ipv6=offï¼šç¦ç”¨ IPv6 æŸ¥è¯¢ï¼ˆå¦‚ä¸éœ€è¦ï¼‰ã€‚

å¦‚æœä¸å†™resolverï¼Œå°±æ— æ³•å»åŠ¨æ€æŸ¥è¯¢ã€‚




