name: Deploy Docs to GitHub Pages & Server

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Build Documentation Site
        run: pnpm run docs:build-site

      - name: Clean Invalid Filenames (Fix Colon Issue)
        run: |
          echo "ğŸ”§ æ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦ï¼ˆå†’å·ï¼‰..."
          find dist -depth -name '*:*' | while read item; do
            new_item=$(echo "$item" | tr ':' '_')
            mv "$item" "$new_item"
            echo "ğŸ“ é‡å‘½å: $item â†’ $new_item"
          done

          echo "âœ… éªŒè¯æ¸…ç†ç»“æœ..."
          if find dist -name '*:*' | grep -q .; then
            echo "âŒ ä»æœ‰åŒ…å«å†’å·çš„æ–‡ä»¶"
            find dist -name '*:*'
            exit 1
          else
            echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶åå·²æ¸…ç†å¹²å‡€"
          fi

      - name: Verify Build Output
        run: |
          if [ ! -d 'dist' ]; then
            echo 'âŒ Build output directory dist not found!'
            exit 1
          else
            echo 'âœ… Build output verified in dist/'
            echo "ğŸ“‚ æ–‡ä»¶æ•°é‡ï¼š$(find dist -type f | wc -l)"
          fi

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Upload Build Artifact for Server
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist/
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-to-server:
    needs: build
    runs-on: ubuntu-latest
    concurrency: deploy-to-server
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: ./dist-to-deploy

      - name: Verify Downloaded Files
        run: |
          echo 'ğŸ“¦ å·²ä¸‹è½½æ„å»ºäº§ç‰©'
          echo "ğŸ“Š æ€»æ–‡ä»¶æ•°ï¼š$(find ./dist-to-deploy -type f | wc -l)"
          echo "ğŸ“ ç›®å½•ç»“æ„ï¼š"
          ls -la ./dist-to-deploy/

      - name: Setup SSH Connection
        run: |
          mkdir -p ~/.ssh

          echo '${{ secrets.SSH_PRIVATE_KEY }}' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo 'ğŸ” éªŒè¯ç§é’¥æ ¼å¼...'
          if ! head -1 ~/.ssh/id_rsa | grep -q 'BEGIN.*PRIVATE KEY'; then
            echo 'âŒ é”™è¯¯ï¼šç§é’¥ç¼ºå°‘ BEGIN æ ‡è®°è¡Œ'
            head -2 ~/.ssh/id_rsa
            exit 1
          fi

          if ! tail -1 ~/.ssh/id_rsa | grep -q 'END.*PRIVATE KEY'; then
            echo 'âŒ é”™è¯¯ï¼šç§é’¥ç¼ºå°‘ END æ ‡è®°è¡Œ'
            tail -2 ~/.ssh/id_rsa
            exit 1
          fi

          echo 'âœ… ç§é’¥æ ¼å¼æ­£ç¡®'

          ssh-keyscan -H '${{ secrets.SERVER_HOST }}' >> ~/.ssh/known_hosts

          echo 'ğŸ”— æµ‹è¯• SSH è¿æ¥...'
          if ssh -o BatchMode=yes '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' 'echo SSHè¿æ¥æˆåŠŸ'; then
            echo 'âœ… SSH è¿æ¥æµ‹è¯•é€šè¿‡'
          else
            echo 'âŒ SSH è¿æ¥å¤±è´¥'
            exit 1
          fi

      - name: Deploy with rsync (Final Fix)
        run: |
          echo 'ğŸš€ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨...'
          echo "ç›®æ ‡è·¯å¾„ï¼š${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}"

          # 1. å®‰è£… rsyncï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
          echo 'ğŸ“¦ ç¡®ä¿ rsync å·²å®‰è£…...'
          sudo apt-get update -qq
          if ! dpkg -l | grep -q rsync; then
            sudo apt-get install -y rsync
          fi

          # 2. æŸ¥æ‰¾ rsync çš„ç»å¯¹è·¯å¾„
          RSYNC_PATH=$(which rsync || echo "/usr/bin/rsync")
          echo "ğŸ” æ‰¾åˆ° rsync è·¯å¾„: $RSYNC_PATH"

          # 3. éªŒè¯ rsync å¯ç”¨æ€§
          echo 'ğŸ” éªŒè¯ rsync å¯ç”¨æ€§...'
          $RSYNC_PATH --version | head -1

          # 4. æ‰‹åŠ¨åˆ·æ–° shell ç¯å¢ƒ
          echo 'ğŸ”„ åˆ·æ–° shell ç¯å¢ƒ...'
          hash -r
          export PATH="/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

          # 5. æ˜¾ç¤ºæºç›®å½•ä¿¡æ¯
          echo 'ğŸ“ æºç›®å½•ä¿¡æ¯ï¼š'
          echo "æ–‡ä»¶æ•°é‡: $(find ./dist-to-deploy -type f | wc -l)"
          echo "ç›®å½•å¤§å°: $(du -sh ./dist-to-deploy)"
          echo "ç¤ºä¾‹æ–‡ä»¶:"
          find ./dist-to-deploy -type f | head -5

          # 6. æ£€æŸ¥ç›®æ ‡ç›®å½•ï¼ˆåŒæ­¥å‰ï¼‰
          echo 'ğŸ” æ£€æŸ¥ç›®æ ‡ç›®å½•ï¼ˆåŒæ­¥å‰ï¼‰...'
          ssh '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' "
            echo 'ç›®æ ‡ç›®å½•: ${{ secrets.TARGET_PATH }}'
            if [ -d '${{ secrets.TARGET_PATH }}' ]; then
              echo 'âœ… ç›®å½•å­˜åœ¨'
              echo 'å½“å‰å†…å®¹:'
              ls -la '${{ secrets.TARGET_PATH }}'
            else
              echo 'âŒ ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º'
            fi
          "

          # 7. æ‰§è¡Œ rsync åŒæ­¥ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
          echo 'ğŸ”„ æ­£åœ¨åŒæ­¥æ–‡ä»¶...'
          $RSYNC_PATH -avz \
            --progress \
            --delete \
            --stats \
            ./dist-to-deploy/ \
            '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}/'

          echo 'âœ… æ–‡ä»¶åŒæ­¥å‘½ä»¤æ‰§è¡Œå®Œæˆ'

          # 8. éªŒè¯åŒæ­¥ç»“æœ
          echo 'ğŸ” éªŒè¯åŒæ­¥ç»“æœ...'
          ssh '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' "
            echo '========== åŒæ­¥éªŒè¯ =========='
            echo 'ç›®æ ‡ç›®å½•: ${{ secrets.TARGET_PATH }}'
            echo 'æ–‡ä»¶æ•°é‡: \$(find ${{ secrets.TARGET_PATH }} -type f | wc -l)'
            echo 'ç›®å½•å¤§å°: \$(du -sh ${{ secrets.TARGET_PATH }})'
            echo 'æœ€æ–°æ–‡ä»¶:'
            find '${{ secrets.TARGET_PATH }}' -type f -exec ls -lh {} \; | head -5
            echo '=============================='
          "

          echo 'ğŸ‰ æ–‡ä»¶åŒæ­¥æµç¨‹å®Œæˆï¼'
      # =============================================
      - name: Final Server Verification
        run: |
          echo 'ğŸ” æœ€ç»ˆæœåŠ¡å™¨éªŒè¯...'
          ssh '${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}' "
            echo '========== æœ€ç»ˆéªŒè¯ =========='
            echo 'æœåŠ¡å™¨æ—¶é—´: \$(date)'
            echo 'éƒ¨ç½²ç›®å½•: ${{ secrets.TARGET_PATH }}'
            echo 'ç›®å½•æƒé™:'
            ls -ld '${{ secrets.TARGET_PATH }}'
            echo 'ç›®å½•å†…å®¹:'
            ls -la '${{ secrets.TARGET_PATH }}'
            echo 'æ–‡ä»¶åˆ—è¡¨:'
            find '${{ secrets.TARGET_PATH }}' -type f | head -10
            echo '=============================='
          "

          echo 'ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼'
